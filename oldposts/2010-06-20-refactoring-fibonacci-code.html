---
layout: post
title: Refactoring Fibonacci code
date: '2010-06-20T02:01:00.001-07:00'
author: Hans Kruse
tags:
- vb.net
modified_time: '2016-08-25T23:37:43.441-07:00'
blogger_id: tag:blogger.com,1999:blog-1516417514149439988.post-1357677239112523417
blogger_orig_url: http://hcjkruse.blogspot.com/2010/06/refactoring-fibonacci-code.html
---

<p>I planned to experiment with Inversion of Control, unit tests and a Mockup Framework under VB.NET using Mono. For this planned to use the Fibonacci example discussed earlier. However in it's present form it is not pleasant to use, reusable or extendible. I want the following: </p><ul><li>Move the fibonacci code in a separate library project. This will allow me to reuse the code more easily;</li><li>Use a check in the MoveNext Code on n&lt;45. This allows me to use <em>For Each</em> in the mainloop and I do not need to explicitly use an Enumarator. This is more the way I am used to program in C#. I suppose this is also common practice in VB.NET. Note that this will be slower;</li><li>Make an Abstract  IntegerEnumerable base class that also contains an Abstract enumerator. This allows me to have the plumbing code in once place and let me concentrate on variations for the MoveNext function;</li><li>Make a prime number finder as a variation; </li></ul><p>When then is done I can do some perfomance analysis code. I am curious about the impact of checking on '45' in the MoveNext(). Also I am interested in some variations of the MoveNext Method. First of I developed the abstract integerenumerable:</p><pre><span style='color: rgb(51,153,51)'>' IntegerEnumerable.vb created with MonoDevelop </span><br /><span style='color: rgb(51,153,51)'>' User: kruse at 12:36 25-1-2009 </span><br /><span style='color: rgb(51,153,51)'>' </span><br /><span style='color: rgb(51,153,51)'>' To change standard headers go to Edit-&gt;Preferences-&gt;Coding-&gt;Standard Headers </span><br /><span style='color: rgb(51,153,51)'>' </span><br /> <br /><span style='color: rgb(0,0,255)'>Option</span><span style='color: rgb(0,0,0)'> Explicit</span><span style='color: rgb(0,0,255)'> On</span><span style='color: rgb(0,0,0)'> </span><br /><span style='color: rgb(0,0,255)'>Option</span><span style='color: rgb(0,0,0)'> Strict</span><span style='color: rgb(0,0,255)'> On</span><span style='color: rgb(0,0,0)'> </span><br /> <br /><span style='color: rgb(0,0,255)'>Imports</span><span style='color: rgb(0,0,0)'> System </span><br /><span style='color: rgb(0,0,255)'>Imports</span><span style='color: rgb(0,0,0)'> System.Collections </span><br /><span style='color: rgb(0,0,255)'>Imports</span><span style='color: rgb(0,0,0)'> System.Collections.Generic </span><br /> <br /><span style='color: rgb(0,0,255)'>Namespace</span><span style='color: rgb(0,0,0)'> EUNemopolis.Math </span><br /><span style='color: rgb(0,0,255)'> Public MustInherit Class</span><span style='color: rgb(0,0,0)'> IntegerEnumerable </span><br /><span style='color: rgb(0,0,255)'> Implements</span><span style='color: rgb(0,0,0)'> IEnumerable(Of</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>) </span><br />     <span style='color: rgb(0,0,255)'> Public Sub New</span><span style='color: rgb(0,0,0)'>() </span><br />    MyBase.New() <br />  <span style='color: rgb(0,0,255)'> End Sub</span><span style='color: rgb(0,0,0)'> </span><hr> <br /> <span style='color: rgb(0,0,255)'> Public Function</span><span style='color: rgb(0,0,0)'> GetEnumerator()</span><span style='color: rgb(0,0,255)'> As</span><span style='color: rgb(0,0,0)'> IEnumerator(Of</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>) _ </span><br /> <span style='color: rgb(0,0,255)'> Implements</span><span style='color: rgb(0,0,0)'> IEnumerable(Of</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>).GetEnumerator </span><br />     <span style='color: rgb(0,0,255)'> Return</span><span style='color: rgb(0,0,0)'> NewEnumerator() </span><br /> <span style='color: rgb(0,0,255)'> End Function</span><span style='color: rgb(0,0,0)'> </span><hr>   <br /> <span style='color: rgb(0,0,255)'> Private Function</span><span style='color: rgb(0,0,0)'> GetEnumerator1()</span><span style='color: rgb(0,0,255)'> As</span><span style='color: rgb(0,0,0)'> IEnumerator _ </span><br /> <span style='color: rgb(0,0,255)'> Implements</span><span style='color: rgb(0,0,0)'> IEnumerable.GetEnumerator </span><br />     <span style='color: rgb(0,0,255)'> Return</span><span style='color: rgb(0,0,0)'> GetEnumerator() </span><br /> <span style='color: rgb(0,0,255)'> End Function</span><span style='color: rgb(0,0,0)'> </span><hr>   <br /> <span style='color: rgb(0,0,255)'> Protected MustOverride Function</span><span style='color: rgb(0,0,0)'> NewEnumerator()</span><span style='color: rgb(0,0,255)'> As</span><span style='color: rgb(0,0,0)'> IEnumerator </span><br />   <br /> <span style='color: rgb(0,0,255)'> Protected</span><span style='color: rgb(0,0,0)'> </span><span style='color: rgb(0,0,255)'> Class</span><span style='color: rgb(0,0,0)'> IntegerEnumerator </span><br /> <span style='color: rgb(0,0,255)'> Implements</span><span style='color: rgb(0,0,0)'> IEnumerator(Of</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>) </span><br /> <span style='color: rgb(0,0,255)'> Private</span><span style='color: rgb(0,0,0)'> _current as</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'> </span><br />     <br />  <span style='color: rgb(0,0,255)'> Public ReadOnly Property</span><span style='color: rgb(0,0,0)'> Current()</span><span style='color: rgb(0,0,255)'> As</span><span style='color: rgb(0,0,0)'> integer _ </span><br />  <span style='color: rgb(0,0,255)'> Implements</span><span style='color: rgb(0,0,0)'> IEnumerator(Of</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>).Current </span><br />       <span style='color: rgb(0,0,255)'> Get</span><span style='color: rgb(0,0,0)'> </span><br />        <span style='color: rgb(0,0,255)'> Return</span><span style='color: rgb(0,0,0)'> _current </span><br />       <span style='color: rgb(0,0,255)'> End Get</span><span style='color: rgb(0,0,0)'> </span><br />  <span style='color: rgb(0,0,255)'> End Property</span><span style='color: rgb(0,0,0)'> </span><hr>  <span style='color: rgb(0,0,255)'> Private</span><span style='color: rgb(0,0,0)'> </span><span style='color: rgb(0,0,255)'> ReadOnly Property</span><span style='color: rgb(0,0,0)'> Current1()</span><span style='color: rgb(0,0,255)'> As</span><span style='color: rgb(153,0,204)'> Object</span><span style='color: rgb(0,0,0)'>  _ </span><br />  <span style='color: rgb(0,0,255)'> Implements</span><span style='color: rgb(0,0,0)'> IEnumerator.Current </span><br />      <span style='color: rgb(0,0,255)'> Get</span><span style='color: rgb(0,0,0)'> </span><br />          <span style='color: rgb(0,0,255)'> Return</span><span style='color: rgb(0,0,0)'> Me.Current </span><br />      <span style='color: rgb(0,0,255)'> End Get</span><span style='color: rgb(0,0,0)'> </span><br />  <span style='color: rgb(0,0,255)'> End Property</span><span style='color: rgb(0,0,0)'> </span><hr>     <span style='color: rgb(0,0,255)'> Protected Sub</span><span style='color: rgb(0,0,0)'> SetCurrent(current as</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>) </span><br />       _current=current <br />     <span style='color: rgb(0,0,255)'> End Sub</span><span style='color: rgb(0,0,0)'> </span><hr>       <br />     <span style='color: rgb(0,0,255)'> Public Sub New</span><span style='color: rgb(0,0,0)'>() </span><br />    MyBase.New() <br />    Init() <br />  <span style='color: rgb(0,0,255)'> End Sub</span><span style='color: rgb(0,0,0)'> </span><hr>       <br />     <span style='color: rgb(0,0,255)'> Public Overridable Function</span><span style='color: rgb(0,0,0)'> MoveNext()</span><span style='color: rgb(0,0,255)'> As</span><span style='color: rgb(153,0,204)'> Boolean</span><span style='color: rgb(0,0,0)'> _ </span><br />  <span style='color: rgb(0,0,255)'> Implements</span><span style='color: rgb(0,0,0)'> System.Collections.IEnumerator.MoveNext </span><br />    return False <br />  <span style='color: rgb(0,0,255)'> End Function</span><span style='color: rgb(0,0,0)'> </span><hr>  <span style='color: rgb(0,0,255)'> Public Overridable Sub</span><span style='color: rgb(0,0,0)'> Init() </span><br />  <span style='color: rgb(0,0,255)'> End Sub</span><span style='color: rgb(0,0,0)'> </span><hr>    <br />  <span style='color: rgb(0,0,255)'> Public Sub</span><span style='color: rgb(0,0,0)'> Reset() _ </span><br />     <span style='color: rgb(0,0,255)'> Implements</span><span style='color: rgb(0,0,0)'> System.Collections.IEnumerator.Reset </span><br />       Init() <br />  <span style='color: rgb(0,0,255)'> End Sub</span><span style='color: rgb(0,0,0)'> </span><hr>    <br />  <span style='color: rgb(0,0,255)'> Public Sub</span><span style='color: rgb(0,0,0)'> Dispose() _ </span><br />  <span style='color: rgb(0,0,255)'> Implements</span><span style='color: rgb(0,0,0)'> IDisposable.Dispose </span><br />   <span style='color: rgb(51,153,51)'>' Empty implementation </span><br />  <span style='color: rgb(0,0,255)'> End Sub</span><span style='color: rgb(0,0,0)'> </span><hr> <span style='color: rgb(0,0,255)'> End Class</span><span style='color: rgb(0,0,0)'> </span><hr>   <span style='color: rgb(0,0,255)'> End Class</span><span style='color: rgb(0,0,0)'> </span><hr><span style='color: rgb(0,0,255)'>End Namespace</span><span style='color: rgb(0,0,0)'> </span><br /></pre><p>Using this code as a base implementing all kinds of mathematica sequences becomes nothing more than implementing the Init() and MoveNext() method. </p><pre><span style='color: rgb(51,153,51)'>' Fibonacci.vb created with MonoDevelop </span><br /><span style='color: rgb(51,153,51)'>' User: kruse at 14:10 22-1-2009 </span><br /><span style='color: rgb(51,153,51)'>' </span><br /><span style='color: rgb(51,153,51)'>' To change standard headers go to Edit-&gt;Preferences-&gt;Coding-&gt;Standard Headers </span><br /><span style='color: rgb(51,153,51)'>' </span><br /> <br /><span style='color: rgb(0,0,255)'>Option</span><span style='color: rgb(0,0,0)'> Explicit</span><span style='color: rgb(0,0,255)'> On</span><span style='color: rgb(0,0,0)'> </span><br /><span style='color: rgb(0,0,255)'>Option</span><span style='color: rgb(0,0,0)'> Strict</span><span style='color: rgb(0,0,255)'> On</span><span style='color: rgb(0,0,0)'> </span><br /> <br /><span style='color: rgb(0,0,255)'>Imports</span><span style='color: rgb(0,0,0)'> System </span><br /><span style='color: rgb(0,0,255)'>Imports</span><span style='color: rgb(0,0,0)'> System.Collections </span><br /><span style='color: rgb(0,0,255)'>Imports</span><span style='color: rgb(0,0,0)'> System.Collections.Generic </span><br /> <br /><span style='color: rgb(0,0,255)'>Namespace</span><span style='color: rgb(0,0,0)'> EUNemopolis.Math </span><br /><span style='color: rgb(0,0,255)'> Public Class</span><span style='color: rgb(0,0,0)'> FibEnumerable </span><br /><span style='color: rgb(0,0,255)'> Inherits</span><span style='color: rgb(0,0,0)'> IntegerEnumerable </span><br />    <br /> <span style='color: rgb(0,0,255)'> Protected Overrides Function</span><span style='color: rgb(0,0,0)'> NewEnumerator() as IEnumerator </span><br />   return<span style='color: rgb(0,0,255)'> New</span><span style='color: rgb(0,0,0)'> FibEnumerator() </span><br /> <span style='color: rgb(0,0,255)'> End Function</span><span style='color: rgb(0,0,0)'> </span><hr>   <br />   <br />    <span style='color: rgb(0,0,255)'> Private Class</span><span style='color: rgb(0,0,0)'> FibEnumerator </span><br />    <span style='color: rgb(0,0,255)'> Inherits</span><span style='color: rgb(0,0,0)'> IntegerEnumerable.IntegerEnumerator </span><br />  <span style='color: rgb(0,0,255)'> Private</span><span style='color: rgb(0,0,0)'> const MAXN</span><span style='color: rgb(0,0,255)'> As Integer</span><span style='color: rgb(0,0,0)'> =45 </span><span style='color: rgb(51,153,51)'>'The maximum n for which Fib(n) fits in an integer </span><br />  <span style='color: rgb(0,0,255)'> Private</span><span style='color: rgb(0,0,0)'> _n</span><span style='color: rgb(0,0,255)'> As Integer</span><span style='color: rgb(0,0,0)'> </span><br />  <span style='color: rgb(0,0,255)'> Private</span><span style='color: rgb(0,0,0)'> _previous</span><span style='color: rgb(0,0,255)'> As Integer</span><span style='color: rgb(0,0,0)'> </span><br />       <br />  <span style='color: rgb(0,0,255)'> Public Function</span><span style='color: rgb(0,0,0)'> MoveNext()</span><span style='color: rgb(0,0,255)'> As</span><span style='color: rgb(153,0,204)'> Boolean</span><span style='color: rgb(0,0,0)'> _ </span><br />  <span style='color: rgb(0,0,255)'> Implements</span><span style='color: rgb(0,0,0)'> System.Collections.IEnumerator.MoveNext </span><br />       if _n&lt;MAXN then <br />        _n=_n+1 <br />       <span style='color: rgb(0,0,255)'> If</span><span style='color: rgb(0,0,0)'> _n&lt;2</span><span style='color: rgb(0,0,255)'> Then</span><span style='color: rgb(0,0,0)'> </span><br />         _previous=Current <br />         SetCurrent(_n) <br />       <span style='color: rgb(0,0,255)'> Else</span><span style='color: rgb(0,0,0)'> </span><br />        <span style='color: rgb(0,0,255)'> Dim</span><span style='color: rgb(0,0,0)'> newCurrent as</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'> </span><br />         newCurrent=_previous+Current <br />         _previous=Current <br />         SetCurrent(newCurrent) <br />       <span style='color: rgb(0,0,255)'> End If</span><span style='color: rgb(0,0,0)'> </span><br />       <span style='color: rgb(0,0,255)'> Return</span><span style='color: rgb(0,0,0)'> True </span><br />      <span style='color: rgb(0,0,255)'> Else</span><span style='color: rgb(0,0,0)'> </span><br />       <span style='color: rgb(0,0,255)'> Return</span><span style='color: rgb(0,0,0)'> False </span><br />      <span style='color: rgb(0,0,255)'> End If</span><span style='color: rgb(0,0,0)'> </span><br />     <span style='color: rgb(0,0,255)'> End Function</span><span style='color: rgb(0,0,0)'> </span><hr>       <br />  <span style='color: rgb(0,0,255)'> Private Overrides Sub</span><span style='color: rgb(0,0,0)'> Init() </span><br />    _n=-1 <span style='color: rgb(51,153,51)'>'illegal value first. Foreach does a movenext first before reading current value </span><br />    SetCurrent(_n) <br />    _previous=_n <br />  <span style='color: rgb(0,0,255)'> End Sub</span><span style='color: rgb(0,0,0)'> </span><hr>    <span style='color: rgb(0,0,255)'> End Class</span><span style='color: rgb(0,0,0)'> </span><hr>   <span style='color: rgb(0,0,255)'> End Class</span><span style='color: rgb(0,0,0)'> </span><hr><span style='color: rgb(0,0,255)'>End Namespace</span><span style='color: rgb(0,0,0)'> </span><br /></pre><p>When developing the code above I discovered that Monodevelop (2.01) did not have an integrated debugger on my system. I am pretty sure that there is a Mono debugger. I also read on the mono website that there was a 2.2 relase of mono with a lot of compiler improvements. So before I continue further coding i better first invest some time in updating my development environment. Another thing I noticed that one easily gets it wrong. Initially the sequence generated was off by one missing the value for n=0. This was because my init() method was never called until I added the forgotten <em>Overrides</em> tag at it. I also got the enumerator wrong. The Current value of an Enumerator is initially undefined. After the first time calling MoveNext() it will have a defined value if the MoveNext() has returned true. </p>