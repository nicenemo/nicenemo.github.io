---
layout: post
title: Memento without lambdas
date: '2010-06-20T02:08:00.001-07:00'
author: Hans Kruse
tags:
- vb.net
modified_time: '2016-08-25T23:37:43.452-07:00'
blogger_id: tag:blogger.com,1999:blog-1516417514149439988.post-5065095369875991056
blogger_orig_url: http://hcjkruse.blogspot.com/2010/06/memoize-in-vbnet.html
---

<p>I am pleased with the idea of a generalised Memoize Function. However my current implementation works from .NET 3.0 upwards because Lambda expressions are available from version 3.0.  In .NET 2.0 there are no Lambda expressions. In C# lambda functions can be easily replaced with anonymous delegate implementations. In VB.NET there is no such thing as anonymous delegate implementations. That does not mean we cannot do implement Memoize in VB.NET. We have to simulate what the compiler does when compiling lambda functions with closure. We Make a class that has three things: </p><ul><li>A Dictionary to serve as cache</li><li>A member to store a reference to the original Function</li><li>The Caching functionality</li><li>A function that gives a Caching function given a function as argument</li></ul><p>In our original main program we also used a lambda function to define Fibonacci recursively in terms of itself. We need to convert that to a normal function. However we cannot let that function call itself because then there would be no way to insert the caching functionality. We do the following: </p><ul><li>We define a "Function Pointer" Fib as  Func(Of Integer,Integer);</li><li>We define a new Function RFib that call the Fib "function pointer" in case n&gt;=2;</li><li>We  set Fib to the Adress of RFib;</li><li>We instantiate a Memoizer m;</li><li>We reassign Fib as Fib=m.Memoize(Fib).</li></ul><p>This allowed me to create a working memoized Fibonacci generator for a 2.0ish VB. Actually I tried this on Mono 2.01. Unfortunately Mono somehow did not like a generalized Memoize. A Generalized version probably will work on Microsoft.NET.  We use the Func(Of integer,integer) generic type. If that is not present in your version of .NET or Mono then it can be replaced with a custom delegate doing the same thing. </p><h3>Source using Generic Function Pointer</h3><pre><span style='color: rgb(0,0,255)'>Option</span><span style='color: rgb(0,0,0)'> Strict</span><span style='color: rgb(0,0,255)'> On</span><span style='color: rgb(0,0,0)'>  </span><br /><span style='color: rgb(0,0,255)'>Option</span><span style='color: rgb(0,0,0)'> Explicit</span><span style='color: rgb(0,0,255)'> On</span><span style='color: rgb(0,0,0)'>  </span><br /><span style='color: rgb(0,0,255)'>Imports</span><span style='color: rgb(0,0,0)'> System  </span><br /><span style='color: rgb(0,0,255)'>Imports</span><span style='color: rgb(0,0,0)'> System.Collections.Generic  </span><br /><span style='color: rgb(0,0,255)'>Imports</span><span style='color: rgb(0,0,0)'> System.Runtime.CompilerServices  </span><br />  <br />  <br /><span style='color: rgb(0,0,255)'>Namespace</span><span style='color: rgb(0,0,0)'> EUNemopolis  </span><br />           <br /> <span style='color: rgb(0,0,255)'> Public Class</span><span style='color: rgb(0,0,0)'> Memoizer </span><br />  <span style='color: rgb(0,0,255)'> Private</span><span style='color: rgb(0,0,0)'> cache as IDictionary(Of</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>,Integer) </span><br />  <span style='color: rgb(0,0,255)'> Private</span><span style='color: rgb(0,0,0)'> _f as Func(Of</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>,Integer) </span><br />  <span style='color: rgb(0,0,255)'> Public Sub New</span><span style='color: rgb(0,0,0)'>() </span><br />    MyBase.New() <br />     cache=new Dictionary(Of<span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>,Integer)() </span><br />  <span style='color: rgb(0,0,255)'> End Sub</span><span style='color: rgb(0,0,0)'> </span><hr><span style='color: rgb(0,0,255)'> Public Function</span><span style='color: rgb(0,0,0)'> M(i as</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>) as</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'> </span><br />     <span style='color: rgb(0,0,255)'> Dim</span><span style='color: rgb(0,0,0)'> result as</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'> </span><br />     <span style='color: rgb(0,0,255)'> If</span><span style='color: rgb(0,0,0)'> cache.Containskey(i)then </span><br />       result=Cache(i) <br />     <span style='color: rgb(0,0,255)'> Else</span><span style='color: rgb(0,0,0)'> </span><br />       result=_f(i) <br />       cache(i)=result <br />     <span style='color: rgb(0,0,255)'> End If</span><span style='color: rgb(0,0,0)'> </span><br />    return result <br />     <br />  <span style='color: rgb(0,0,255)'> End Function</span><span style='color: rgb(0,0,0)'> </span><hr><span style='color: rgb(0,0,255)'> Public Function</span><span style='color: rgb(0,0,0)'> Memoize(f as Func(Of integer,integer)) _ </span><br />      as Func(Of integer,integer) <br />        _f=f <br />       <span style='color: rgb(0,0,255)'> Return</span><span style='color: rgb(0,0,0)'> new Func(Of</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>,Integer) (AddressOf M) </span><br />    <span style='color: rgb(0,0,255)'> End Function</span><span style='color: rgb(0,0,0)'> </span><hr><span style='color: rgb(0,0,255)'> End Class</span><span style='color: rgb(0,0,0)'> </span><hr><span style='color: rgb(0,0,255)'> Module</span><span style='color: rgb(0,0,0)'> Program </span><br />  <span style='color: rgb(0,0,255)'> Public</span><span style='color: rgb(0,0,0)'> Fib</span><span style='color: rgb(0,0,255)'> As</span><span style='color: rgb(0,0,0)'> Func(Of</span><span style='color: rgb(153,0,204)'> Int32</span><span style='color: rgb(0,0,0)'>,Int32) </span><br />        <span style='color: rgb(0,0,255)'> Public Function</span><span style='color: rgb(0,0,0)'> RFib(n as</span><span style='color: rgb(153,0,204)'> Int32</span><span style='color: rgb(0,0,0)'>) as int32 </span><br />        <span style='color: rgb(0,0,255)'> Dim</span><span style='color: rgb(0,0,0)'> result as</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'> </span><br />        <span style='color: rgb(0,0,255)'> If</span><span style='color: rgb(0,0,0)'>(n&lt;2) then </span><br />          result=n <br />        <span style='color: rgb(0,0,255)'> Else</span><span style='color: rgb(0,0,0)'> </span><br />          result=Fib(n-1)+Fib(n-2) <br />        <span style='color: rgb(0,0,255)'> End If</span><span style='color: rgb(0,0,0)'> </span><br />         return result <br />       <span style='color: rgb(0,0,255)'> End Function</span><span style='color: rgb(0,0,0)'> </span><hr><span style='color: rgb(0,0,255)'> Public Sub</span><span style='color: rgb(0,0,0)'> Main()  </span><br />            System.Console.WriteLine("Hello World")   <br />            Fib = new Func(Of<span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>,Integer)(AddressOf rfib) </span><br />           <span style='color: rgb(0,0,255)'> Dim</span><span style='color: rgb(0,0,0)'> m as</span><span style='color: rgb(0,0,255)'> New</span><span style='color: rgb(0,0,0)'> Memoizer() </span><br />      Fib=m.Memoize(Fib) <br />      <br />      <br />           <span style='color: rgb(0,0,255)'> Dim</span><span style='color: rgb(0,0,0)'> i</span><span style='color: rgb(0,0,255)'> As Integer</span><span style='color: rgb(0,0,0)'>  </span><br />           <span style='color: rgb(0,0,255)'> For</span><span style='color: rgb(0,0,0)'> i = 0</span><span style='color: rgb(0,0,255)'> To</span><span style='color: rgb(0,0,0)'> 45 </span><br />                System.Console.WriteLine(String.Format("{0:d},{1:d}", i, Fib(i)))  <br />           <span style='color: rgb(0,0,255)'> Next</span><span style='color: rgb(0,0,0)'>  </span><br />            System.Console.WriteLine("Done")  <br />            System.Console.ReadLine()  <br />       <span style='color: rgb(0,0,255)'> End Sub</span><span style='color: rgb(0,0,0)'>  </span><hr>   <span style='color: rgb(0,0,255)'> End Module</span><span style='color: rgb(0,0,0)'>  </span><br />  <br /><span style='color: rgb(0,0,255)'>End Namespace</span><span style='color: rgb(0,0,0)'>  </span><br /></pre><h3>Source using custom delegate</h3><pre><span style='color: rgb(0,0,255)'>Option</span><span style='color: rgb(0,0,0)'> Strict</span><span style='color: rgb(0,0,255)'> On</span><span style='color: rgb(0,0,0)'>  </span><br /><span style='color: rgb(0,0,255)'>Option</span><span style='color: rgb(0,0,0)'> Explicit</span><span style='color: rgb(0,0,255)'> On</span><span style='color: rgb(0,0,0)'>  </span><br /><span style='color: rgb(0,0,255)'>Imports</span><span style='color: rgb(0,0,0)'> System  </span><br /><span style='color: rgb(0,0,255)'>Imports</span><span style='color: rgb(0,0,0)'> System.Collections.Generic  </span><br /><span style='color: rgb(0,0,255)'>Imports</span><span style='color: rgb(0,0,0)'> System.Runtime.CompilerServices  </span><br />  <br />  <br /><span style='color: rgb(0,0,255)'>Namespace</span><span style='color: rgb(0,0,0)'> EUNemopolis  </span><br /> <span style='color: rgb(0,0,255)'> Public</span><span style='color: rgb(153,0,204)'> Delegate</span><span style='color: rgb(0,0,255)'> Function</span><span style='color: rgb(0,0,0)'> FPointer(i as</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>)</span><span style='color: rgb(0,0,255)'> As Integer</span><span style='color: rgb(0,0,0)'>           </span><br /> <span style='color: rgb(0,0,255)'> Public Class</span><span style='color: rgb(0,0,0)'> Memoizer </span><br />  <span style='color: rgb(0,0,255)'> Private</span><span style='color: rgb(0,0,0)'> cache as IDictionary(Of</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>,Integer) </span><br />  <span style='color: rgb(0,0,255)'> Private</span><span style='color: rgb(0,0,0)'> _f as FPointer </span><br />  <span style='color: rgb(0,0,255)'> Public Sub New</span><span style='color: rgb(0,0,0)'>() </span><br />    MyBase.New() <br />     cache=new Dictionary(Of<span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>,Integer)() </span><br />  <span style='color: rgb(0,0,255)'> End Sub</span><span style='color: rgb(0,0,0)'> </span><hr><span style='color: rgb(0,0,255)'> Public Function</span><span style='color: rgb(0,0,0)'> M(i as</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'>) as</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'> </span><br />     <span style='color: rgb(0,0,255)'> Dim</span><span style='color: rgb(0,0,0)'> result as</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'> </span><br />     <span style='color: rgb(0,0,255)'> If</span><span style='color: rgb(0,0,0)'> cache.Containskey(i)then </span><br />       result=Cache(i) <br />     <span style='color: rgb(0,0,255)'> Else</span><span style='color: rgb(0,0,0)'> </span><br />       result=_f(i) <br />       cache(i)=result <br />     <span style='color: rgb(0,0,255)'> End If</span><span style='color: rgb(0,0,0)'> </span><br />    return result <br />     <br />  <span style='color: rgb(0,0,255)'> End Function</span><span style='color: rgb(0,0,0)'> </span><hr><span style='color: rgb(0,0,255)'> Public Function</span><span style='color: rgb(0,0,0)'> Memoize(f as FPointer) _ </span><br />      as FPointer <br />        _f=f <br />       <span style='color: rgb(0,0,255)'> Return</span><span style='color: rgb(0,0,0)'> new FPointer (AddressOf M) </span><br />    <span style='color: rgb(0,0,255)'> End Function</span><span style='color: rgb(0,0,0)'> </span><hr><span style='color: rgb(0,0,255)'> End Class</span><span style='color: rgb(0,0,0)'> </span><hr><span style='color: rgb(0,0,255)'> Module</span><span style='color: rgb(0,0,0)'> Program </span><br />  <span style='color: rgb(0,0,255)'> Public</span><span style='color: rgb(0,0,0)'> Fib</span><span style='color: rgb(0,0,255)'> As</span><span style='color: rgb(0,0,0)'> FPointer </span><br />        <span style='color: rgb(0,0,255)'> Public Function</span><span style='color: rgb(0,0,0)'> RFib(n as</span><span style='color: rgb(153,0,204)'> Int32</span><span style='color: rgb(0,0,0)'>) as int32 </span><br />        <span style='color: rgb(0,0,255)'> Dim</span><span style='color: rgb(0,0,0)'> result as</span><span style='color: rgb(0,0,255)'> Integer</span><span style='color: rgb(0,0,0)'> </span><br />        <span style='color: rgb(0,0,255)'> If</span><span style='color: rgb(0,0,0)'>(n&lt;2) then </span><br />          result=n <br />        <span style='color: rgb(0,0,255)'> Else</span><span style='color: rgb(0,0,0)'> </span><br />          result=Fib(n-1)+Fib(n-2) <br />        <span style='color: rgb(0,0,255)'> End If</span><span style='color: rgb(0,0,0)'> </span><br />         return result <br />       <span style='color: rgb(0,0,255)'> End Function</span><span style='color: rgb(0,0,0)'> </span><hr><span style='color: rgb(0,0,255)'> Public Sub</span><span style='color: rgb(0,0,0)'> Main()  </span><br />            System.Console.WriteLine("Hello World")   <br />            Fib = new FPointer(AddressOf rfib) <br />           <span style='color: rgb(0,0,255)'> Dim</span><span style='color: rgb(0,0,0)'> m as</span><span style='color: rgb(0,0,255)'> New</span><span style='color: rgb(0,0,0)'> Memoizer() </span><br />      Fib=m.Memoize(Fib) <br />      <br />      <br />           <span style='color: rgb(0,0,255)'> Dim</span><span style='color: rgb(0,0,0)'> i</span><span style='color: rgb(0,0,255)'> As Integer</span><span style='color: rgb(0,0,0)'>  </span><br />           <span style='color: rgb(0,0,255)'> For</span><span style='color: rgb(0,0,0)'> i = 0</span><span style='color: rgb(0,0,255)'> To</span><span style='color: rgb(0,0,0)'> 45 </span><br />                System.Console.WriteLine(String.Format("{0:d},{1:d}", i, Fib(i)))  <br />           <span style='color: rgb(0,0,255)'> Next</span><span style='color: rgb(0,0,0)'>  </span><br />            System.Console.WriteLine("Done")  <br />            System.Console.ReadLine()  <br />       <span style='color: rgb(0,0,255)'> End Sub</span><span style='color: rgb(0,0,0)'>  </span><hr>   <span style='color: rgb(0,0,255)'> End Module</span><span style='color: rgb(0,0,0)'>  </span><br />  <br /><span style='color: rgb(0,0,255)'>End Namespace</span><span style='color: rgb(0,0,0)'>  </span><br /></pre><h3>Memoize in C# using anonymous delegates</h3><pre><span style='color: rgb(51,153,51)'>// Main.cs created with MonoDevelop </span><br /><span style='color: rgb(51,153,51)'>// User: kruse at 15:18Â 26-1-2009 </span><br /><span style='color: rgb(51,153,51)'>// </span><br /><span style='color: rgb(51,153,51)'>// To change standard headers go to Edit-&gt;Preferences-&gt;Coding-&gt;Standard Headers </span><br /><span style='color: rgb(51,153,51)'>// </span><br /><span style='color: rgb(0,0,255)'>using</span><span style='color: rgb(0,0,0)'> System; </span><br /><span style='color: rgb(0,0,255)'>using</span><span style='color: rgb(0,0,0)'> System.Collections; </span><br /><span style='color: rgb(0,0,255)'>using</span><span style='color: rgb(0,0,0)'> System.Collections.Generic; </span><br /><span style='color: rgb(0,0,255)'>namespace</span><span style='color: rgb(0,0,0)'> MemoizeFibCSharp </span><br />{ <br /><span style='color: rgb(0,0,255)'> public class</span><span style='color: rgb(0,0,0)'> Memoizer </span><br /> { <br /> <span style='color: rgb(0,0,255)'> public static</span><span style='color: rgb(0,0,0)'>  Func&lt;T,R&gt; Memoize&lt;T,R&gt;(Func&lt;T, R&gt; func) </span><br />  { <br />   Dictionary&lt;T, R&gt; cache =<span style='color: rgb(0,0,255)'> new</span><span style='color: rgb(0,0,0)'> Dictionary&lt;T, R&gt;(); </span><br />   return<span style='color: rgb(0,0,255)'> delegate</span><span style='color: rgb(0,0,0)'>(T key) </span><br />   { <br />    R result; <br />   <span style='color: rgb(0,0,255)'> if</span><span style='color: rgb(0,0,0)'> (cache.TryGetValue(key,</span><span style='color: rgb(0,0,255)'> out</span><span style='color: rgb(0,0,0)'> result)) </span><br />     return result; <br />    cache[key] = result = func(key); <br />    return result; <br />   }; <br />  }  <br /> } <br />   <br /><span style='color: rgb(0,0,255)'> class</span><span style='color: rgb(0,0,0)'> MainClass </span><br /> { <br />   <br /> <br /> <span style='color: rgb(0,0,255)'> public static void</span><span style='color: rgb(0,0,0)'> Main(string[] args) </span><br />  { <br />   Console.WriteLine("Hello World!"); <br />   Func&lt;Int32, Int32&gt; fib = null; <br />   fib =<span style='color: rgb(0,0,255)'> delegate</span><span style='color: rgb(0,0,0)'>(int n){ return n &gt; 1 ? fib(n - 1) + fib(n - 2) : n;}; </span><br />   fib = Memoizer.Memoize&lt;Int32,Int32&gt;(fib); <br />  <br />  <span style='color: rgb(0,0,255)'> for</span><span style='color: rgb(0,0,0)'>(int i=0;i&lt;46;i++) </span><br />   { <br />    Console.WriteLine(String.Format("{0:d},{1:d}",i,fib(i))); <br />   } <br />       <br /> <br />  } <br /> } <br />} <br /></pre>