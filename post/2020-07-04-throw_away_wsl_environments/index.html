<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:title" content="Throw away WSL environments"><meta property="og:description" content="A rainy weekend is a perfect opportunity to do some yak shaving and learn a few things.  I created
a WSL Debian boxes, a collection of PowerShell and Bash scripts
that enable you to spin up fresh updated and Ansible enabled WSL 2, based machines at lightning speed. Create an environment to test software. Yak shave your development environment and more."><meta property="og:type" content="article"><meta property="og:url" content="https://hanskruse.eu/post/2020-07-04-throw_away_wsl_environments/"><meta property="article:published_time" content="2020-07-04T23:31:09+02:00"><meta property="article:modified_time" content="2020-07-04T23:31:09+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Throw away WSL environments"><meta name=twitter:description content="A rainy weekend is a perfect opportunity to do some yak shaving and learn a few things.  I created
a WSL Debian boxes, a collection of PowerShell and Bash scripts
that enable you to spin up fresh updated and Ansible enabled WSL 2, based machines at lightning speed. Create an environment to test software. Yak shave your development environment and more."><title>Throw away WSL environments | Hans Kruse</title><link rel=icon type=image/png href=https://hanskruse.eu/images/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=https://hanskruse.eu/images/favicon-32x32.png sizes=32x32><link href="https://fonts.googleapis.com/css?family=Oswald:400" rel=stylesheet><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css integrity=sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://hanskruse.eu/css/bundle.min.b97f193de70a99ff0493bab9f65bdc1a4620f1d92b801069ccd3b39cd1f972f5.css integrity="sha256-uX8ZPecKmf8Ek7q59lvcGkYg8dkrgBBpzNOznNH5cvU="><link rel=icon type=image/png href=https://hanskruse.eu/images/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=https://hanskruse.eu/images/favicon-32x32.png sizes=32x32><link rel=alternate type=application/rss+xml href=https://hanskruse.eu/index.xml><meta charset=utf-8><meta name=author content="Hans Kruse"><meta name=copyright content="Copyright © 2014–2020, Hans Kruse  all rights reserved."><meta name=description content="A rainy weekend is a perfect opportunity to do some yak shaving and learn a few things. I created a WSL Debian boxes, a collection of PowerShell and Bash scripts that enable you to spin up fresh updated and Ansible enabled WSL 2, based machines at lightning speed. Create an environment to test software. Yak shave your development environment and more."></head><body><nav class="navbar fixed-top navbar-expand-md navbar-dark bg-dark py-1 top-nav"><div class=container><a class="navbar-brand pr-2" href=https://hanskruse.eu/>HANS KRUSE</a>
<button class="navbar-toggler collapsed" type=button data-toggle=collapse data-target=#navbarCollapse aria-controls=navbarCollapse aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-bars"></i></button><div class="navbar-collapse collapse" id=navbarCollapse><ul class="navbar-nav mr-auto"><li class=nav-item><a class="nav-link active" href=https://hanskruse.eu/about/>About</a></li><li class=nav-item><a class="nav-link active" href=https://resume.hanskruse.eu>Resume</a></li></ul><div class="social-icons d-none d-lg-block"><a class="py-2 px-2" href=https://hanskruse.eu/index.xml><i class="fas fa-rss"></i></a></div></div></div></nav><header class="feature-image d-print-none"></header><div class=main><div class="container mt-4 post"><h1>Throw away WSL environments</h1><div class=mb-3><small><strong>By Hans Kruse</strong>
| <i class="far fa-calendar-alt"></i>&nbsp;Jul 4, 2020&nbsp;
| <i class="fa fa-tags" title=Tags aria-hidden=true></i><a href=https://hanskruse.eu/tags/wsl/>wsl</a>, <a href=https://hanskruse.eu/tags/debian/>debian</a>, <a href=https://hanskruse.eu/tags/powershell/>powershell</a>, <a href=https://hanskruse.eu/tags/ansible/>ansible</a>, <a href=https://hanskruse.eu/tags/no-snowflake/>no-snowflake</a>, <a href=https://hanskruse.eu/tags/dev-box/>dev-box</a>, <a href=https://hanskruse.eu/tags/yak-shaving/>yak-shaving</a></small></div><div class="share-icons d-flex justify-content-center d-print-none"><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fhanskruse.eu%2fpost%2f2020-07-04-throw_away_wsl_environments%2f&text=Throw%20away%20WSL%20environments&tw_p=tweetbutton" class=p-2 title="Share on Twitter" target=_blank rel=nofollow><div><span class=fa-stack><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></div><div class="fa-inverse text-center"><small>Tweet</small></div></a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fhanskruse.eu%2fpost%2f2020-07-04-throw_away_wsl_environments%2f&t=Throw%20away%20WSL%20environments" class=p-2 title="Share on Facebook" target=_blank rel=nofollow><div><span class=fa-stack><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-facebook fa-stack-1x fa-inverse"></i></span></div><div class="fa-inverse text-center"><small>Share</small></div></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fhanskruse.eu%2fpost%2f2020-07-04-throw_away_wsl_environments%2f&title=Throw%20away%20WSL%20environments&source=mattbutton.com" class=p-2 title="Share on LinkedIn" target=_blank rel=nofollow><div><span class=fa-stack><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></div><div class="fa-inverse text-center"><small>Share</small></div></a><a href=javascript:window.print() title="Print this article" class=p-2 target=_blank rel=nofollow><div><span class=fa-stack><i class="fas fa-circle fa-stack-2x"></i><i class="fa fa-print fa-stack-1x fa-inverse"></i></span></div><div class="fa-inverse text-center"><small>Print</small></div></a></div><div class="mt-4 mb-4 main-content"><p>A rainy weekend is a perfect opportunity to do some yak shaving and learn a few things. I created
a <a href=https://github.com/nicenemo/wsl-debian-boxes>WSL Debian boxes</a>, a collection of PowerShell and Bash scripts
that enable you to spin up fresh updated and Ansible enabled <a href=https://en.wikipedia.org/wiki/Windows_Subsystem_for_Linux>WSL</a> 2, based machines at lightning speed. Create an environment to test software. Yak shave your development environment and more.</p><p>The last few weeks for me were partially about automating virtual environment creation as part of my job, using:</p><ul><li><a href=https://www.ansible.com/>Ansible</a>.</li><li><a href=https://www.jeffgeerling.com/>Jef Geerling&rsquo;s</a> excellent book
<a href=https://leanpub.com/ansible-for-devops>Ansible for Devops</a></li><li>the related <a href="https://www.youtube.com/playlist?list=PL2_OBreMn7FqZkvMYt6ATmgC0KAGGJNAN">Ansible 101</a> YouTube video series.</li></ul><p>One of the terms Jeff coined was <em>snowflake server</em>, a machine that is (partially),
configured and updated by hand. Some changes are not documented and it is not possible to recreate the machine in case of disaster. My development machine, is very similar to a snowflake server. How about your development machine?
Recreation of my machine on fresh hardware without lots of manual steps is impossible. Installing it takes a day. Next it takes days for all the things I forgot. Change is needed. Perhaps Ansible is part of a solution.</p><p>I tried automating the installation of a Windows machine before, by using <a href=https://boxstarter.org/>Box Starter</a>
and the <a href=https://chocolatey.org/>Choclatey</a>. I did not get it stable or complete.
By using Ansible and with a bit more experience it may be possible.
Unfortunately Ansible does not really run on Windows.
You can manage Windows machines using Ansible from Linux.
That is exactly the plan: a self-contained automated installation of my development machine, using WSL and Ansible.</p><p>After an initial Windows install, an automated mechanism will bootstrap a WSL environment.
The WSL environment then configures the rest of the machine using Ansible. The same Ansible based solution can then be used to:</p><ul><li>Run Windows updates</li><li>Update Installed software on Windows using Chocolatey</li><li>Update apps installed via the Windows store.</li><li>If possible run the Lenovo Vantage updater from my laptop.</li><li>Update WSL Linux environments on the machine.</li></ul><p>As a first step, automate the creation of a clean and fresh minimal WSL Linux environment.
My current WSL environment is a snowflake, so that is an unstable basis. This need to be able to create, configure and destroy a fresh WSL Linux environment at lightning speed. No manual steps are allowed.</p><p>My current WSL environment is <a href=https://github.com/WhitewaterFoundry>Pengwin</a> Linux from White Water Foundry.
A very comfortable WSL environment with all the bells and whistles. It has to go because:</p><ul><li>On initial startup it asks you to configure several aspects using a menu system.</li><li>How to automate that?</li><li>A more minimal Linux suits my needs, since I am ready and willing to take more control again.</li></ul><p>Being comfortable with Debian based Linux environments, I decided to go with the real thing. The WSL
Debian image is very minimal. Perfect for my needs. Sadly it is based on the older Debian 9, <em>Stretch</em>. Upgrading will be explained in a moment.</p><p>WSL Linux distributions can be downloaded and install from the store.
This is slow and you cannot install multiple instances of the same app.
For this use case Microsoft suggests doing a
<a href=https://docs.microsoft.com/en-us/windows/wsl/install-manual>direct download</a>
of your favourite distribution. The initial download is still slow but every install can be done faster from a local file. This still does allow yo to install multiple instances of the same <em>Linux app</em>. For this you can use WSL&rsquo;s <code>wsl --export</code> and <code>wsl --import</code> options. This allows you to import and export a so-called tar archive, often called tar ball, from your installed <em>Linux app</em>. A tar ball can be installed multiple times to create multiple virtual machines.</p><p>My <a href=https://github.com/nicenemo/wsl-debian-boxes/blob/develop/bootstrap-debian-images.PS1>bootstrap-debian-images.PS1</a> does the following:</p><ol><li>Download the <em>WSL Debian Linux App</em></li><li>Install the app</li><li>Do the post install without installing a normal user. No questions are asked and if you start the app you will be logged in as root. Perfect for automation.</li><li>Copy an apt sources.list into the image. This allows me to use a broader package selection and also allows me to use a local mirror.</li><li>Upgrade the software installed in the image. Since the image was made, quite a few updates where released. This will speed up fresh installation.</li><li>Create a tar ball for Debian Stretch.</li><li>Copy an apt sources.list for Debian Buster into the image. This again allows me to use a broader package selection and also allows me to use a local mirror.</li><li>Upgrade the machine</li><li>Create a tar ball for Debian Buster.</li><li>Copy an apt sources.list for Debian Bullseye into the image. This again allows me to use a broader package selection and also allows me to use a local mirror.</li><li>Upgrade the machine</li><li>Create a tar ball for Debian Bullseye.</li><li>Remove the WSL Debian machine</li><li>Uninstall the Debian Windows store app.</li><li>Remove the downloaded Windows store app.</li></ol><p>You now how 3 freshly baked tar balls for Stretch, Buster and Bullseye.
These can be used with my <a href=https://github.com/nicenemo/wsl-debian-boxes/blob/develop/create-machine.PS1>create-machine.PS1</a> script. This script performs the following:</p><ol><li>Create a WSL virtual machine with the tar ball of your choice</li><li>Upgrades the software, since it might have been a while since the last time you created the tar balls.</li><li>Install Python3 and Pip3.</li><li>Create a user</li><li>Give the created user sudo rights</li><li>Make the user the default user for use with WSL. You no longer get a root prompt.</li><li>Make a <em>winhome</em> soft link to your Windows home directory in your Linux user&rsquo;s home directory.</li><li>Add ~/.local/bin to the path of the user.</li><li>Try to update <em>pip</em> as the user. Because, sudo is not used, this will result in an updated pip in the user&rsquo;s <code>~/.local/bin</code> directory.</li><li>Install <em>Ansible</em> as the user. Since, sudo is not used, this will result in Ansible being installed in the user&rsquo;s <code>~/.local/bin</code></li></ol><p>No further updates were made. This is for creating a base image.
Further updates and customization should be done using Ansible.
Ansible is declarative and in general more readable and easier to maintain than Shell scripts.</p><p>If you look into the scripts you will notice some Bash scripts and shell commands to upgrade and install the software. Ansible was not used, because Ansible running on the machine that you update does break because of Python upgrades.</p><p>Running an all Linux solution instead of PowerShell is possible but not very practical. That would mean you need to have a WSL machine first. The current amount of PowerShell needed for bootstrapping is limited and acceptable.</p><p>The machines are not installed with an SSH server yet. They are intended as something to use Ansible from, not, as something to administer with Ansible from the outside for now.</p><p>Networking in WSL is a bit complicated. Every WSL machine is in its own isolated subnet and ports are only accessible via port forwarding on the host. From within WSL, the host is available on the default route IP address. Sadly after reboot the network addresses used changed. So administering the windows host from within WSL using Ansible will be an extra challenge besides installing an SSH server on the host first.</p><p>If you used <a href=https://www.vagrantup.com/>Vagrant</a> and or <a href=https://www.packer.io/>Packer</a> before, then the approach taken should look familiar. These tools abstract and or simplify the creation and deployment of virtual machine images and environments on various virtualization solutions. Perhaps they will support WSL one day to create WSL boxes. Then these scripts can be retired.</p><p>The scripts still need some maturing.
Please do read the <a href=https://github.com/nicenemo/wsl-debian-boxes/blob/develop/README.md>README</a>
if you use it.
You currently need to navigate to the directory of the scripts to use them.
For me they are already quite useable for creating test environments and
Yak shaving the ultimate development machine.</p><div class="share-icons d-flex justify-content-center d-print-none"><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fhanskruse.eu%2fpost%2f2020-07-04-throw_away_wsl_environments%2f&text=Throw%20away%20WSL%20environments&tw_p=tweetbutton" class=p-2 title="Share on Twitter" target=_blank rel=nofollow><div><span class=fa-stack><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></div><div class="fa-inverse text-center"><small>Tweet</small></div></a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fhanskruse.eu%2fpost%2f2020-07-04-throw_away_wsl_environments%2f&t=Throw%20away%20WSL%20environments" class=p-2 title="Share on Facebook" target=_blank rel=nofollow><div><span class=fa-stack><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-facebook fa-stack-1x fa-inverse"></i></span></div><div class="fa-inverse text-center"><small>Share</small></div></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fhanskruse.eu%2fpost%2f2020-07-04-throw_away_wsl_environments%2f&title=Throw%20away%20WSL%20environments&source=mattbutton.com" class=p-2 title="Share on LinkedIn" target=_blank rel=nofollow><div><span class=fa-stack><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></div><div class="fa-inverse text-center"><small>Share</small></div></a><a href=javascript:window.print() title="Print this article" class=p-2 target=_blank rel=nofollow><div><span class=fa-stack><i class="fas fa-circle fa-stack-2x"></i><i class="fa fa-print fa-stack-1x fa-inverse"></i></span></div><div class="fa-inverse text-center"><small>Print</small></div></a></div></div></div><div class="sidebar d-print-none d-none d-xl-block"><h2>Hans Kruse</h2><div>Monadic programmer - Software Engineer with a passion for cooking.</div><a href=https://hanskruse.eu/about/ class="btn btn-outline-secondary mt-3" role=button>Read More...</a><h2 class=mt-4>Top Posts</h2><h2 class=mt-4>Recent Posts</h2><nav class="nav flex-column"><a href=https://hanskruse.eu/post/2020-07-04-throw_away_wsl_environments/ class=nav-link>Throw away WSL environments</a>
<a href=https://hanskruse.eu/post/2020-06-07-thoughts_on_kubernetes_on_smartos/ class=nav-link>Thoughts on Kubernetes on SmartOS</a>
<a href=https://hanskruse.eu/post/2020-05-23-keys_to_your_fingers/ class=nav-link>Move the keys to your fingers</a>
<a href=https://hanskruse.eu/post/2018-09-04-vanilla-java/ class=nav-link>Vanilla Java for stream copy</a></nav><h2 class="mt-4 text-capitalize">categories</h2><nav class="nav flex-column"><a href=https://hanskruse.eu/categories/testing/ class=nav-link>testing
<span class="badge badge-pill badge-secondary">1</span></a></nav><h2 class="mt-4 text-capitalize">tags</h2><nav class="nav flex-column"><a href=https://hanskruse.eu/tags/annoying/ class=nav-link>annoying
<span class="badge badge-pill badge-secondary">1</span></a>
<a href=https://hanskruse.eu/tags/ansible/ class=nav-link>ansible
<span class="badge badge-pill badge-secondary">1</span></a>
<a href=https://hanskruse.eu/tags/debian/ class=nav-link>debian
<span class="badge badge-pill badge-secondary">1</span></a>
<a href=https://hanskruse.eu/tags/dev-box/ class=nav-link>dev-box
<span class="badge badge-pill badge-secondary">1</span></a>
<a href=https://hanskruse.eu/tags/docker/ class=nav-link>docker
<span class="badge badge-pill badge-secondary">1</span></a>
<a href=https://hanskruse.eu/tags/ergonomics/ class=nav-link>ergonomics
<span class="badge badge-pill badge-secondary">1</span></a>
<a href=https://hanskruse.eu/tags/gear/ class=nav-link>gear
<span class="badge badge-pill badge-secondary">1</span></a>
<a href=https://hanskruse.eu/tags/home-automation/ class=nav-link>home-automation
<span class="badge badge-pill badge-secondary">1</span></a>
<a href=https://hanskruse.eu/tags/java/ class=nav-link>java
<span class="badge badge-pill badge-secondary">1</span></a>
<a href=https://hanskruse.eu/tags/kubernetes/ class=nav-link>kubernetes
<span class="badge badge-pill badge-secondary">1</span></a></nav></div></div><footer class="mt-auto footer d-print-none"><div class=container-fluid><div class="row justify-content-center"><div class="col-md-4 col-xl-3"><h5>Copyright © 2014–2020, Hans Kruse all rights reserved.</h5>Feel free to share this content non commercially, Attribution-NonCommercial-ShareAlike</div><div class="col-md-4 col-xl-3"><h5>Disclaimer</h5>Opinions expressed here are my own and may not reflect those of the company I work for, or the people I work with.</div><div class="col-md-4 col-xl-3"><h5>About This Site</h5>This blog was created using the <a href=https://gohugo.io/>Hugo</a> static site generator, using
<a href=https://getbootstrap.com/>Bootstrap</a>, using the Silhouette Hugo theme, created by
<a href=https://www.mattbutton.com>Matt Button</a></div></div><hr><div class="d-flex justify-content-center icons"><a class="py-2 px-2" href=https://hanskruse.eu/index.xml><i class="fas fa-rss"></i></a></div></div></footer><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script></body></html>